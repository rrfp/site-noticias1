<!DOCTYPE html>
<html lang="pt-BR" data-theme="<%= theme %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Site Not√≠cias</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body class="home-page">

  <!-- Topbar -->
  <div class="topbar">
    <h1 class="brand">Not√≠cias</h1>

    <div style="display:flex; gap:15px; align-items:center;">
      <!-- Bot√£o Tema -->
      <button id="toggleTheme" class="theme-toggle">
        Tema: <%= theme === "dark" ? "üåô Escuro" : "‚òÄÔ∏è Claro" %>
      </button>

      <!-- Login / Logout -->
      <% if (user) { %>
        <div class="topbar__user">
          <span class="welcome">Ol√°, <%= user.name %></span>
          <a href="/logout" class="btn btn-logout">Sair</a>
        </div>
      <% } else { %>
        <a href="/auth/login" class="btn btn-login">Login</a>
      <% } %>
    </div>
  </div>

  <!-- Not√≠cias -->
  <% if (user && articles && articles.length > 0) { %>
    <div class="news-grid">
      <% articles.forEach(article => { %>
        <div class="card" data-id="<%= article._id %>">
          <% if (article.urlToImage) { %>
            <div class="card__media">
              <img src="<%= article.urlToImage %>" alt="">
            </div>
          <% } %>
          <div class="card__content">
            <h3 class="card__title"><a href="<%= article.url %>" target="_blank"><%= article.title %></a></h3>
            <p class="card__desc"><%= article.description %></p>
            <div class="card__meta">
              <span class="badge"><%= article.source %></span>
              <span class="like-btn" data-liked="<%= article.likes.includes(user._id) %>">
                ‚ù§Ô∏è <span class="likes-count"><%= article.likes.length %></span>
              </span>
            </div>

            <div class="comment-section">
              <input type="text" placeholder="Adicionar coment√°rio..." class="comment-input">
              <button class="comment-btn">Comentar</button>
              <div class="comments-list">
                <% article.comments.forEach(c => { %>
                  <div><strong><%= c.username %>:</strong> <%= c.text %></div>
                <% }) %>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } else if (user && (!articles || articles.length === 0)) { %>
    <div class="site-wrap">
      <h2>Nenhuma not√≠cia encontrada</h2>
    </div>
  <% } %>

  <script>
    // Tema
    const btnTheme = document.getElementById("toggleTheme");
    btnTheme.addEventListener("click", async () => {
      const html = document.documentElement;
      const current = html.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      html.setAttribute("data-theme", next);
      btnTheme.textContent = next === "dark" ? "Tema: üåô Escuro" : "Tema: ‚òÄÔ∏è Claro";

      await fetch("/set-theme", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ theme: next })
      });
    });

    // Likes
    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const card = btn.closest('.card');
        const newsId = card.dataset.id;
        const res = await fetch(`/api/news/${newsId}/like`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          btn.querySelector('.likes-count').textContent = data.likesCount;
          const liked = btn.getAttribute('data-liked') === 'true';
          btn.setAttribute('data-liked', !liked);
        }
      });
    });

    // Coment√°rios
    document.querySelectorAll('.comment-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const card = btn.closest('.card');
        const newsId = card.dataset.id;
        const input = card.querySelector('.comment-input');
        const text = input.value.trim();
        if (!text) return;

        const res = await fetch(`/api/news/${newsId}/comment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });

        const data = await res.json();
        if (data.success) {
          const commentsList = card.querySelector('.comments-list');
          const div = document.createElement('div');
          div.innerHTML = `<strong>${data.comment.username}:</strong> ${data.comment.text}`;
          commentsList.appendChild(div);
          input.value = '';
        }
      });
    });
  </script>
</body>
</html>
